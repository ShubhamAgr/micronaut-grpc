<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script src="/cdn-cgi/apps/head/3cOPSgo5Omz84ycX7CvigfX4cpw.js"></script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-82213539-2"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-82213539-2');
    </script>
    <title>3 GRPC Server 2.0.4.BUILD-SNAPSHOT</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen, print" title="Style" charset="utf-8"/>
    <link rel="stylesheet" href="../css/pdf.css" type="text/css" media="print" title="PDF" charset="utf-8"/>
    <script type="text/javascript">
function addJsClass() {
    var classes = document.body.className.split(" ");
    classes.push("js");
    document.body.className = classes.join(" ");
}
    </script>
</head>

<body class="body" onload="addJsClass();">
<div id="navigation">
    <div class="navTitle">
        
        Micronaut GRPC
    </div>
    <div class="navLinks">
        <ul>
            <li>
                <div id="nav-summary" onmouseover="toggleNavSummary(false)" onmouseout="toggleNavSummary(true)">
                    <a href="../guide/index.html" class="button">Table of contents</a>

                    <div id="nav-summary-childs" style="display:none;">
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/introduction.html"><strong>1</strong><span>Introduction</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/gettingStarted.html"><strong>2</strong><span>Getting Started</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/server.html"><strong>3</strong><span>GRPC Server</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/client.html"><strong>4</strong><span>GRPC Clients</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/serviceDiscovery.html"><strong>5</strong><span>Service Discovery</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/tracing.html"><strong>6</strong><span>Distributed Tracing</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/protocolBuffers.html"><strong>7</strong><span>Protocol Buffers Support</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/repository.html"><strong>8</strong><span>Repository</span></a>
                        </div>
                        
                    </div>
                </div>
            </li>
            <li class="separator selected">
                <a id="ref-button" onclick="localToggle(); return false;" href="#">Quick Reference</a>
            </li>
        </ul>
    </div>


</div>

<table id="colset" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td id="col1">
            <div id="main" class="corner-all">

                
                    <div class="toc-item prev-left"><a href="../guide/gettingStarted.html">&lt;&lt; <strong>2</strong><span>Getting Started</span></a></div>
                

                <span id='toggle-col1' class="toggle">(<a href="#" onclick="localToggle(); return false;">Quick Reference</a>)</span>

                
                    <div class="toc-item next-right"><a href="../guide/client.html"><strong>4</strong><span>GRPC Clients</span> >></a></div>
                


                <div class="project">
                    <h1>3 GRPC Server</h1>

                    <p><strong>Version:</strong> 2.0.4.BUILD-SNAPSHOT</p>
                </div>

                

                
<h1 id="server"><a class="anchor" href="#server"></a>3 GRPC Server</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-grpc/edit/master/src/main/docs/guide/server.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="sect2">
<h3 id="_writing_a_simple_grpc_server">Writing a Simple GRPC Server</h3>
<div class="paragraph">
<p>To implement a GRPC server for the previously defined <code>helloworld.proto</code> definition you first need to generate the Java stubs using Gradle or Maven then create a class that extends from <code>GreeterGrpc.GreeterImplBase</code>.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">import io.grpc.stub.StreamObserver;
import javax.inject.Singleton;

@Singleton
public class GreetingEndpoint extends GreeterGrpc.GreeterImplBase { <b class="conum">(1)</b>

    private final GreetingService greetingService;

    <b class="conum">(2)</b>
    public GreetingEndpoint(GreetingService greetingService) {
        this.greetingService = greetingService;
    }

    @Override
    public void sayHello(HelloRequest request, StreamObserver&lt;HelloReply&gt; responseObserver) {
        <b class="conum">(3)</b>
        final String message = greetingService.sayHello(request.getName());
        HelloReply reply = HelloReply.newBuilder().setMessage(message).build();
        responseObserver.onNext(reply);
        responseObserver.onCompleted();
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">import groovy.transform.CompileStatic
import io.grpc.stub.StreamObserver
import javax.inject.Singleton

@CompileStatic
@Singleton
class GreetingEndpoint extends GreeterGrpc.GreeterImplBase { <b class="conum">(1)</b>

    final GreetingService greetingService

    <b class="conum">(2)</b>
    GreetingEndpoint(GreetingService greetingService) {
        this.greetingService = greetingService
    }

    @Override
    void sayHello(HelloRequest request, StreamObserver&lt;HelloReply&gt; responseObserver) {
        <b class="conum">(3)</b>
        HelloReply.newBuilder().with {
            message = greetingService.sayHello(request.name)
            responseObserver.onNext(build())
            responseObserver.onCompleted()
        }
    }
}</code></pre>
</div>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlight"><code class="language-kotlin" data-lang="kotlin">import javax.inject.Singleton

@Singleton <b class="conum">(1)</b>
@Suppress("unused")
class GreetingEndpoint(val greetingService : GreetingService) : GreeterGrpcKt.GreeterCoroutineImplBase() { <b class="conum">(2)</b>
    override suspend fun sayHello(request: HelloRequest): HelloReply {
        <b class="conum">(3)</b>
        val message = greetingService.sayHello(request.name)
        val reply = HelloReply.newBuilder().setMessage(message).build()
        return reply
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The class extends from <code>GreeterGrpc.GreeterImplBase</code> and is annotated with <code>javax.inject.Singleton</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>You can dependency inject other beans into the implementation. In this case <code>GreetingService</code> is dependency injected.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>StreamObserver</code> is used to send a response to the client.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_running_the_grpc_server">Running the GRPC Server</h3>
<div class="paragraph">
<p>To run the server use the <code>Application</code> class or run <code>./gradlew run</code> for Gradle or <code>./mvnw compile exec:exec</code> for Maven.</p>
</div>
<div class="paragraph">
<p>The server by default runs on port 50051, however you can configure which port the server runs on by setting <code>grpc.server.port</code> to whichever value you wish (a value of <code>${random.port}</code> will use a random port).</p>
</div>
</div>
<div class="sect2">
<h3 id="_configuring_the_grpc_server">Configuring the GRPC Server</h3>
<div class="paragraph">
<p>The server can be be configured in a number of different ways. You can use the <code>io.micronaut.grpc.server.GrpcServerConfiguration</code> type to configure any property of GRPC&#8217;s <code>NettyServerBuilder</code> class via <code>application.yml</code>.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="title">Configuring the GRPC server</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">grpc:
    server:
        port: 8080
        keep-alive-time: 3h
        max-inbound-message-size: 1024
        ssl:
            cert-chain: '/path/to/my.cert'
            private-key: '/path/to/my.key'</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default the GRPC server will be enabled. To disable the GRPC server, set <code>grpc.server.enabled</code> to false.</p>
</div>
<div class="paragraph">
<p>Alternatively if you prefer programmatic configuration you can write a <code>BeanCreationListener</code> for example:</p>
</div>
<div class="listingblock">
<div class="title">Configuring the ServerBuilder</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">/*
 * Copyright 2017-2019 original authors
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package io.micronaut.grpc;

import io.grpc.ServerBuilder;
import io.micronaut.context.event.BeanCreatedEvent;
import io.micronaut.context.event.BeanCreatedEventListener;

import javax.inject.Singleton;

@Singleton
public class ServerBuilderListener implements BeanCreatedEventListener&lt;ServerBuilder&lt;?&gt;&gt; {
    @Override
    public ServerBuilder&lt;?&gt; onCreated(BeanCreatedEvent&lt;ServerBuilder&lt;?&gt;&gt; event) {
        final ServerBuilder&lt;?&gt; builder = event.getBean();
        builder.maxInboundMessageSize(1024);
        return builder;
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_auto_injected_types">Auto Injected Types</h3>
<div class="paragraph">
<p>By default the server will automatically be dependency injected with beans of the following types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>io.grpc.BindableService</code> - Any services declared as beans</p>
</li>
<li>
<p><code>io.grpc.ServerInterceptor</code> - Any interceptors declared as beans</p>
</li>
<li>
<p><code>io.grpc.ServerTransportFilter</code> - Any transport filters declared as beans</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In addition, by default the server will be setup to use Micronaut&#8217;s I/O executor service.</p>
</div>
<div class="sect3">
<h4 id="_server_interceptor_ordering">Server Interceptor Ordering</h4>
<div class="paragraph">
<p>To produce a consistent and predictable order of execution for server interceptors, it is required
for the <code>io.grpc.ServerInterceptor</code> implementation to do one of the following:</p>
</div>
<div class="listingblock">
<div class="title">Implement <code>io.micronaut.core.order.Ordered</code> interface</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Singleton <i class="conum" data-value="1"></i><b>(1)</b>
public class CustomInterceptor implements ServerInterceptor, Ordered { <i class="conum" data-value="2"></i><b>(2)</b>
    ...

    @Override
    public int getOrder() {
        return 10; <i class="conum" data-value="3"></i><b>(3)</b>
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Declare the server interceptor as a bean to have it registered automatically</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Implement <code>Ordered</code> in addition to <code>ServerInterceptor</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Provide the specified order of execution in the server interceptor chain</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Wrap with <code>io.micronaut.grpc.server.interceptor.OrderedServerInterceptor</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Factory <i class="conum" data-value="1"></i><b>(1)</b>
public class ServerInterceptorFactory {

    @Bean <i class="conum" data-value="2"></i><b>(2)</b>
    @Singleton
    public ServerInterceptor customSeverInterceptor() {
        return new OrderedServerInterceptor(new CustomInterceptor(), 10); <i class="conum" data-value="3"></i><b>(3)</b>
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use a <code>@Factory</code> to create an instance of <code>ServerInterceptor</code> bean</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Register the created sever interceptor as a bean</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Wrap the <code>CustomInterceptor</code> with <code>OrderedServerInterceptor</code> and provide the <code>order</code> of execution</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The order which is provided will dictate the order of execution of the interceptors when receiving the request message,
and then the order will be reversed when sending the response message.</p>
</div>
<div class="listingblock">
<div class="title">3 interceptors, with respective orders, <code>1</code>, <code>2</code>, and <code>3</code>:</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-txt hljs" data-lang="txt">Request -&gt; 1 -&gt; 2 -&gt; 3 -&gt; business logic -&gt; 3 -&gt; 2 -&gt; 1 -&gt; Response</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_testing_the_server">Testing the Server</h3>
<div class="paragraph">
<p>To test the server it is recommended that you use <a href="https://github.com/micronaut-projects/micronaut-test">Micronaut Test</a>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
For detailed instructions on how to setup Micronaut Test for either Spock or JUnit 5 see the <a href="https://micronaut-projects.github.io/micronaut-test/latest/guide/index.html">documentation</a> on the subject.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can then define a blocking stub bean in <code>src/test/java</code>. For example:</p>
</div>
<div class="listingblock">
<div class="title">Defining Test Clients</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Factory
class Clients {
    @Bean
    GreeterGrpc.GreeterBlockingStub blockingStub(
            @GrpcChannel(GrpcServerChannel.NAME) ManagedChannel channel) { <i class="conum" data-value="1"></i><b>(1)</b>
        return GreeterGrpc.newBlockingStub( <i class="conum" data-value="2"></i><b>(2)</b>
                channel
        );
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>A <code>ManagedChannel</code> is injected that can communicate with the server.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The generated GRPC client blocking stub is created.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The above example uses the <code>@GrpcChannel</code> annotation to inject a GRPC <code>ManagedChannel</code> that can communicate with the running server. This channel will be automatically be shutdown when the application shuts down.</p>
</div>
<div class="paragraph">
<p>Now that you have a test client, writing the test becomes trivial:</p>
</div>
<div class="listingblock multi-language-sample">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">import io.grpc.ManagedChannel;
import io.micronaut.context.annotation.*;
import io.micronaut.grpc.annotation.GrpcChannel;
import io.micronaut.grpc.server.GrpcServerChannel;
import io.micronaut.test.annotation.MicronautTest;
import static org.junit.jupiter.api.Assertions.*;
import org.junit.jupiter.api.Test;

import javax.inject.Inject;

@MicronautTest <b class="conum">(1)</b>
public class GreetingEndpointTest {

    @Inject
    GreeterGrpc.GreeterBlockingStub blockingStub; <b class="conum">(2)</b>

    @Test
    void testHelloWorld() {
        final HelloRequest request = HelloRequest.newBuilder() <b class="conum">(3)</b>
                                                 .setName("Fred")
                                                 .build();
        assertEquals(
                "Hello Fred",
                blockingStub.sayHello(request)
                            .getMessage()
        );
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The test is annotated with <code>@MicronautTest</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The client stub is injected into the test</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>A request is sent and the response asserted.</td>
</tr>
</table>
</div>
</div>


                <div style="clear:both;margin-top:15px;"></div>
                
                    <div class="toc-item prev-left"><a href="../guide/gettingStarted.html">&lt;&lt; <strong>2</strong><span>Getting Started</span></a></div>
                
                    <div class="toc-item next-right"><a href="../guide/client.html"><strong>4</strong><span>GRPC Clients</span> >></a></div>
                
                <div style="clear:both"></div>
            </div>
        </td>
        <td id="col2">
            <div class="local clearfix">
                <div class="local-title">
                    <a href="../guide/index.html" target="mainFrame">Quick Reference</a>
                    <span class="toggle">(<a href="#" onclick="localToggle(); return false;">hide</a>)</span>
                </div>
                <div class="menu">
                    
                </div>
            </div>
        </td>
    </tr>
</table>

<div id="footer">
    
    
</div>

<script type="text/javascript" src="../js/docs.js"></script>

</body>
</html>
